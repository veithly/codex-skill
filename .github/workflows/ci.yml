name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate:
    name: Validate Skill Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate package.json
        run: |
          echo "Validating package.json..."
          node -e "JSON.parse(require('fs').readFileSync('package.json'))"
          echo "✓ package.json is valid JSON"

      - name: Validate .claude-skill.json
        run: |
          echo "Validating .claude-skill.json..."
          node -e "JSON.parse(require('fs').readFileSync('.claude-skill.json'))"
          echo "✓ .claude-skill.json is valid JSON"

      - name: Check required files
        run: |
          echo "Checking required files..."
          for file in SKILL.md agent.md reference.md README.md LICENSE; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
            else
              echo "✗ $file is missing"
              exit 1
            fi
          done

      - name: Check scripts
        run: |
          echo "Checking script files..."
          for file in scripts/codex-runner.sh scripts/codex-runner.ps1 scripts/codex-yolo.sh scripts/codex-yolo.cmd; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
            else
              echo "✗ $file is missing"
              exit 1
            fi
          done

      - name: Lint shell scripts
        run: |
          echo "Checking shell scripts syntax..."
          bash -n scripts/codex-runner.sh
          bash -n scripts/codex-yolo.sh
          bash -n scripts/install/install.sh
          bash -n scripts/install/uninstall.sh
          echo "✓ Shell scripts are valid"

  test-install:
    name: Test Installation
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18, 20, 22]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Create Claude directories
        shell: bash
        run: |
          mkdir -p ~/.claude/commands
          mkdir -p ~/.claude/agents
          mkdir -p ~/.claude/scripts

      - name: Run npm install script (Unix)
        if: runner.os != 'Windows'
        run: node scripts/npm-install.js

      - name: Run npm install script (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: node scripts/npm-install.js

      - name: Verify installation (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "Verifying installation..."
          [ -f ~/.claude/commands/codex/SKILL.md ] && echo "✓ SKILL.md installed"
          [ -f ~/.claude/agents/codex.md ] && echo "✓ agent.md installed"

      - name: Verify installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Verifying installation..."
          if (Test-Path "$env:USERPROFILE\.claude\commands\codex\SKILL.md") {
            Write-Host "✓ SKILL.md installed"
          }
          if (Test-Path "$env:USERPROFILE\.claude\agents\codex.md") {
            Write-Host "✓ agent.md installed"
          }
